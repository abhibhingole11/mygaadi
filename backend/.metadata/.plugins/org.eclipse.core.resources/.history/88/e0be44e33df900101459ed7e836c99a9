package com.mygaadi.service;

import java.util.List;

import java.util.stream.Collectors;

import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.mygaadi.dto.AddCarRequest;
import com.mygaadi.dto.AdminCarResponse;
import com.mygaadi.dto.BuyerCarResponse;
import com.mygaadi.entity.Car;
import com.mygaadi.entity.CarStatus;
import com.mygaadi.entity.Transaction;
import com.mygaadi.entity.User;
import com.mygaadi.repository.CarRepository;
import com.mygaadi.repository.TransactionRepository;
import com.mygaadi.repository.UserRepository;
import com.mygaadi.repository.WishlistRepository;

@Service
public class CarService {

    private final CarRepository carRepository;
    private final UserRepository userRepository;
    private final TransactionRepository transactionRepository;
    private final  WishlistRepository wishlistRepository;
    private final CloudinaryService cloudinaryService;

    public CarService(CarRepository carRepository, UserRepository userRepository,TransactionRepository transactionRepository,WishlistRepository wishlistRepository,CloudinaryService cloudinaryService) {
        this.carRepository = carRepository;
        this.userRepository = userRepository;
        this.transactionRepository = transactionRepository;
        this.wishlistRepository = wishlistRepository;
        this.cloudinaryService = cloudinaryService;
    }
    public List<Car> getPendingCars() {
        return carRepository.findByStatus(CarStatus.PENDING);
    }

    

    public void addCar(
            String make,
            String model,
            int year,
            double price,
            Long sellerId,
            MultipartFile image
    ) {

        User seller = userRepository.findById(sellerId)
                .orElseThrow(() -> new RuntimeException("Seller not found"));

        // upload image to Cloudinary
        String imageUrl = cloudinaryService.uploadImage(image);

        Car car = new Car();
        car.setMake(make);
        car.setModel(model);
        car.setYear(year);
        car.setPrice(price);
        car.setSeller(seller);
        car.setImageUrl(imageUrl);
        car.setStatus(CarStatus.PENDING);

        carRepository.save(car);
    }

    public void approveCar(Long carId) {
    	Car car = carRepository.findById(carId).orElseThrow(()->new RuntimeException("car non found"));
    	car.setStatus(CarStatus.APPROVED);
    	carRepository.save(car);
    }
    public void rejectCar(Long carId) {
    	Car car = carRepository.findById(carId).orElseThrow(()->new RuntimeException("car not fond"));
        car.setStatus(CarStatus.REJECTED);
        carRepository.save(car);
    
    
    }
    public List<BuyerCarResponse>getApprovedCars(){
    	return carRepository.findByStatus(CarStatus.APPROVED).stream()
    			.map(car->{
    				BuyerCarResponse dto = new BuyerCarResponse();
    				dto.carId = car.getCarId();
    				 dto.make = car.getMake();
    	                dto.model = car.getModel();
    	                dto.year = car.getYear();
    	                dto.price = car.getPrice();
    	                dto.fuelType = car.getFuelType();
    	                dto.transmission = car.getTransmission();
    	                dto.sellerName = car.getSeller().getFirstName();
    	                return dto;
    			}).collect(Collectors.toList());
    			
    	
    	
    }


    public List<BuyerCarResponse> getCarsByFilters(
            String keyword, Double maxPrice, Integer minYear) {

        List<Car> cars;

        if (keyword != null && !keyword.isBlank()) {
            cars = carRepository
                    .findByStatusAndMakeContainingIgnoreCaseOrStatusAndModelContainingIgnoreCase(
                            CarStatus.APPROVED, keyword,
                            CarStatus.APPROVED, keyword
                    );

        } else if (maxPrice != null) {
            cars = carRepository
                    .findByStatusAndPriceLessThanEqual(CarStatus.APPROVED, maxPrice);

        } else if (minYear != null) {
            cars = carRepository
                    .findByStatusAndYearGreaterThanEqual(CarStatus.APPROVED, minYear);

        } else {
            cars = carRepository.findByStatus(CarStatus.APPROVED);
        }

        return cars.stream()
                .map(car -> {
                    BuyerCarResponse dto = new BuyerCarResponse();
                    dto.carId = car.getCarId();
                    dto.make = car.getMake();
                    dto.model = car.getModel();
                    dto.year = car.getYear();
                    dto.price = car.getPrice();
                    dto.fuelType = car.getFuelType();
                    dto.transmission = car.getTransmission();
                    dto.sellerName = car.getSeller().getFirstName();
                    return dto;
                })
                .collect(Collectors.toList());
    }
    public void buyCar(Long buyerId, Long carId) {

        User buyer = userRepository.findById(buyerId)
                .orElseThrow(() -> new RuntimeException("Buyer not found"));

        Car car = carRepository.findById(carId)
                .orElseThrow(() -> new RuntimeException("Car not found"));

        if (car.getStatus() != CarStatus.APPROVED) {
            throw new RuntimeException("Car is not available");
        }

        // mark car sold
        car.setStatus(CarStatus.SOLD);
        carRepository.save(car);

        // save transaction
        Transaction tx = new Transaction();
        tx.setBuyer(buyer);
        tx.setCar(car);
        transactionRepository.save(tx);

        // remove from wishlist
        wishlistRepository.findByBuyerAndCar(buyer, car)
                .ifPresent(wishlistRepository::delete);
    }
    public List<AdminCarResponse> getAllCars() {

        return carRepository.findAll()
                .stream()
                .map(car -> {
                    AdminCarResponse dto = new AdminCarResponse();
                    dto.carId = car.getCarId();
                    dto.make = car.getMake();
                    dto.model = car.getModel();
                    dto.price = car.getPrice();
                    dto.year = car.getYear();
                    dto.status = car.getStatus().name();
                    return dto;
                })
                .toList();
    }


}
