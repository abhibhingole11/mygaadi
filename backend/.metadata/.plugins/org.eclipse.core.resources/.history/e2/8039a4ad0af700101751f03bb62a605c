package com.mygaadi.service;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;

import com.mygaadi.dto.AddWishlistRequest;
import com.mygaadi.dto.WishlistResponse;
import com.mygaadi.entity.Car;
import com.mygaadi.entity.User;
import com.mygaadi.entity.Wishlist;
import com.mygaadi.repository.CarRepository;
import com.mygaadi.repository.UserRepository;
import com.mygaadi.repository.WishlistRepository;

@Service
public class WishlistService {

    private final WishlistRepository wishlistRepository;
    private final UserRepository userRepository;
    private final CarRepository carRepository;

    public WishlistService(
            WishlistRepository wishlistRepository,
            UserRepository userRepository,
            CarRepository carRepository) {
        this.wishlistRepository = wishlistRepository;
        this.userRepository = userRepository;
        this.carRepository = carRepository;
    }

    // ‚ûï Add to wishlist
    public void addToWishlist(AddWishlistRequest request) {

        User buyer = userRepository.findById(request.buyerId)
                .orElseThrow(() -> new RuntimeException("Buyer not found"));

        Car car = carRepository.findById(request.carId)
                .orElseThrow(() -> new RuntimeException("Car not found"));

        boolean exists = wishlistRepository
                .findByBuyerAndCar(buyer, car)
                .isPresent();

        if (exists) {
            throw new RuntimeException("Car already in wishlist");
        }

        Wishlist wishlist = new Wishlist();
        wishlist.setBuyer(buyer);
        wishlist.setCar(car);

        wishlistRepository.save(wishlist);
    }

    // üìÑ View wishlist
    public List<WishlistResponse> getWishlist(Long buyerId) {

        User buyer = userRepository.findById(buyerId)
                .orElseThrow(() -> new RuntimeException("Buyer not found"));

        return wishlistRepository.findByBuyerUserId(buyer)
                .stream()
                .map(w -> {
                    WishlistResponse dto = new WishlistResponse();
                    dto.wishlistId = w.getWishlistId();
                    dto.carId = w.getCar().getCarId();
                    dto.make = w.getCar().getMake();
                    dto.model = w.getCar().getModel();
                    dto.price = w.getCar().getPrice();
                    return dto;
                })
                .collect(Collectors.toList());
    }

    // ‚ùå Remove from wishlist
    public void removeFromWishlist(Long wishlistId) {
        wishlistRepository.deleteById(wishlistId);
    }
}
